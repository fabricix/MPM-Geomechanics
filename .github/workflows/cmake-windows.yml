name: CMake-Windows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      # Step 1: Clone the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up MSYS2 with MinGW64 and install required tools
      - name: Setup MSYS2 with MinGW64
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            zip
            git

      # Step 3: Configure the project using CMake and Ninja
      - name: Configure with CMake using Ninja
        shell: msys2 {0}
        run: cmake -G "Ninja" -S build/CMake -B build/CMake

      # Step 4: Build the project
      - name: Build with CMake
        shell: msys2 {0}
        run: cmake --build build/CMake

      # Step 5: Create distribution folder and copy executable
      - name: Create dist folder and copy executable
        shell: msys2 {0}
        run: |
          mkdir -p dist
          cp build/CMake/MPM-Geomechanics.exe dist/

      # Step 6: Automatically detect and copy required DLLs using ldd
      - name: Detect and copy runtime DLLs
        shell: msys2 {0}
        run: |
          cd dist
          # Copy only DLLs located in mingw64 path
          for dll in $(ldd MPM-Geomechanics.exe | grep mingw64 | awk '{print $3}'); do
            cp "$dll" .
          done

      # Step 7: Zip the executable and its DLL dependencies
      - name: Zip executable and DLLs
        shell: msys2 {0}
        run: zip -j MPM-Geomechanics-windows.zip dist/*

      # Step 8: Upload the ZIP file as an artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MPM-Geomechanics-windows
          path: MPM-Geomechanics-windows.zip

      - name: (tests) Clone GoogleTest into external directory
        shell: msys2 {0}
        run: git clone --branch v1.17.0 https://github.com/google/googletest.git external/googletest

      - name: (tests) Configure with CMake using Ninja
        shell: msys2 {0}
        run: cmake -G "Ninja" -S build/qa -B build/qa -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_STANDARD_REQUIRED=ON -DCMAKE_CXX_EXTENSIONS=OFF

      - name: (tests) Build with CMake
        shell: msys2 {0}
        run: cmake --build build/qa

      - name: (tests) Run tests
        shell: msys2 {0}
        run: ./MPM-Geomechanics-tests.exe
        working-directory: build/qa

      - name: (tests) Run benchmark
        shell: msys2 {0}
        run: ./MPM-Geomechanics-benchmark.exe
        working-directory: build/qa

      - name: (tests) Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: MPM-Geomechanics-benchmark-windows
          path: build/qa/MPM-Geomechanics-benchmark.exe
